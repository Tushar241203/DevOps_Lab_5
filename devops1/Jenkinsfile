pipeline {
    agent any

    environment {
        APP_NAME = 'flask-demo'
        IMAGE = "${env.DOCKERHUB_USER ?: 'your-dockerhub-username'}/${APP_NAME}"
        TAG = "${env.BUILD_NUMBER}"
        DOCKER_HOST = 'tcp://dind:2375' // provided by docker-compose
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Unit Tests') {
            steps {
                dir('app') {
                    sh 'python --version || true'
                    sh 'pip --version || true'
                    sh 'python -m pip install -r requirements.txt'
                    sh 'pytest -q'
                }
            }
        }

        stage('Build Image') {
            steps {
                dir('app') {
                    script {
                        docker.withServer(env.DOCKER_HOST) {
                            def built = docker.build("${IMAGE}:${TAG}")
                            built.push()
                            sh "docker tag ${IMAGE}:${TAG} ${IMAGE}:latest"
                            sh "docker push ${IMAGE}:latest"
                        }
                    }
                }
            }
        }

        stage('Deploy (Run Container)') {
            steps {
                script {
                    docker.withServer(env.DOCKER_HOST) {
                        sh 'docker rm -f demo || true'
                        sh "docker run -d --name demo -p 8000:8000 ${IMAGE}:latest"
                    }
                }
            }
        }

        stage('Smoke Test') {
            steps {
                sh 'sleep 2' // give the container a moment
                sh 'curl -fsS http://localhost:8000/ | tee smoke.json'
            }
        }
    }
}
